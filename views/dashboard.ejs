<!DOCTYPE html>
<html lang="en" data-bs-theme="dark"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>DaBeat - Explore</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<link href="css/style.css" rel="stylesheet">


  </head>
	<body class="d-flex flex-column min-vh-100 text-white">
		<%
  const savedQuery = `search=${search}&genre=${genre}&sort=${sort}&showFav=${showFav ? "on" : ""}`;
%>

	<style>
        body {
          background: url("/img/party_audience_on_spotlight_background_2107.jpg") center/cover no-repeat;
        }
        body::before {
          content: "";
          position: fixed;
          inset: 0;
          background: inherit;
          filter: blur(20px);
          z-index: -1;
        }
  </style>
  <% function toTitleCase(str) {
  return str
    .toLowerCase()
    .split(' ') 
    .map(word => word.charAt(0).toUpperCase() + word.slice(1)) 
    .join(' '); 
} %>

<nav class="navbar navbar-expand-lg navbar-dark bg-black bg-opacity-50">
    <div class="container-fluid">
        <a class="navbar-brand" href="/home"><h1><i class="bi bi-vinyl-fill"></i> DaBeat</h1></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNavDarkDropdown">
            <ul class="navbar-nav nav nav-underline me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/home"><i class="bi bi-houses-fill"></i> Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/dashboard"><i class="bi bi-music-player-fill"></i> Explore</a>
                </li>
            </ul>

            <hr class="d-lg-none text-white-50">
            
            <!-- Conditional rendering based on login status -->
            <% if (user) { %>
                <!-- Logged in user - show profile dropdown -->
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fs-5" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <%= user.username %>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                            <li><a class="dropdown-item" href="/upload"><i class="bi bi-upload"></i> Upload</a></li>
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-bounding-box"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear-fill"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Account actions</h6></li>
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-door-closed"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            <% } else { %>
                <!-- Not logged in - show login/signup buttons -->
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-box-arrow-in-right"></i> Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-primary text-white ms-2" href="/"><i class="bi bi-person-plus"></i> Sign Up</a>
                    </li>
                </ul>
            <% } %>
        </div>
    </div>
</nav>	
<% if (user?.isAdmin && !previewNormal){ %>
    <div class="text-success-emphasis p-3 bg-opacity-10m-0" style="background-color: #051b1160;">
        <p>Currently in <strong>admin</strong> mode.</p>
		<h4>As an admin, you can:</h4>
		<ul>
			<li>Delete and edit any song regardless of ownership.</li>
			<li>Post news and annoucements on the main explore page.</li>
		</ul>		
		<p>You can also see how the explore page appears for normal users. This preview can be switched back anytime.</p>
		<a href="<%- buildQueryString(currentPage) %>&previewNormal=true" class="btn btn-secondary"><i class="bi bi-binoculars-fill me-3"></i>Preview page as a non-admin user</a>
	</div>

<% } else if (previewNormal){ %>
    <div class="text-success-emphasis p-3 bg-opacity-10m-0" style="background-color: #051b1160;">
        <p>Currently in <strong>normal preview</strong> mode.</p>
		<br>
		<a href="<%- buildQueryString(currentPage, false) %>" class="btn btn-secondary"><i class="bi bi-binoculars-fill me-3"></i>View page as admin</a>
	</div>
<% } %>



<div class="container-fluid flex-fill d-flex flex-column">
	
	<div class="row bg-opacity-50 pt-3 bg-black h-100 flex-fill">
				<div class="col-md-8">
					<div class="bg-black bg-opacity-25 h-100 p-3 d-flex flex-column rounded-3">
					<form class="container-fluid mb-4" method="GET" action="/dashboard">

						<div class="input-group mb-3">
						<span class="input-group-text"><i class="bi bi-search"></i></span>
						<div class="form-floating w-25">
							<input name="search" type="text" class="form-control" id="searchInput" placeholder="Name">
							<label for="searchInput">Search for songs you like...</label>					
						</div>
						<div class="form-floating">
							 	 <select name="genre" class="form-select" id="genreSelect" aria-label="Floating label select example">
					<option value="any" selected>Any / Unknown</option>
					<hr>

                    <optgroup label="Pop & Mainstream">
                      <option value="pop">Pop</option>
                      <option value="indie-pop">Indie Pop</option>
                      <option value="k-pop">K-Pop</option>
                      <option value="j-pop">J-Pop</option>
                      <option value="vocaloid">Vocaloid</option>
                      <option value="dance-pop">Dance Pop</option>
                      <option value="electropop">Electropop</option>
                    </optgroup>

                    <optgroup label="Rock & Metal">
                      <option value="rock">Rock</option>
                      <option value="alternative">Alternative</option>
                      <option value="indie-rock">Indie Rock</option>
                      <option value="punk">Punk</option>
                      <option value="metal">Metal</option>
                      <option value="hard-rock">Hard Rock</option>
                      <option value="grunge">Grunge</option>
                    </optgroup>

                    <optgroup label="Electronic & EDM">
                      <option value="electronic">Electronic</option>
                      <option value="house">House</option>
                      <option value="techno">Techno</option>
                      <option value="trance">Trance</option>
                      <option value="dubstep">Dubstep</option>
                      <option value="drum-and-bass">Drum and Bass</option>
                      <option value="future-bass">Future Bass</option>
                      <option value="hardstyle">Hardstyle</option>
                      <option value="edm">EDM</option>
                      <option value="synthwave">Synthwave</option>
                      <option value="lofi">Lo-fi</option>
                      <option value="chillout">Chillout</option>
                      <option value="ambient">Ambient</option>
                    </optgroup>

                    <optgroup label="Hip-Hop & Urban">
                      <option value="hip-hop">Hip-Hop</option>
                      <option value="rap">Rap</option>
                      <option value="trap">Trap</option>
                      <option value="rnb">R&B</option>
                      <option value="soul">Soul</option>
                      <option value="funk">Funk</option>
                    </optgroup>

                    <optgroup label="Classical & Acoustic">
                      <option value="classical">Classical</option>
                      <option value="opera">Opera</option>
                      <option value="instrumental">Instrumental</option>
                      <option value="acoustic">Acoustic</option>
                      <option value="soundtrack">Soundtrack</option>
                      <option value="experimental">Experimental</option>
                    </optgroup>

                    <optgroup label="World & Cultural">
                      <option value="reggae">Reggae</option>
                      <option value="dancehall">Dancehall</option>
                      <option value="reggaeton">Reggaeton</option>
                      <option value="afrobeat">Afrobeat</option>
                      <option value="latin">Latin</option>
                      <option value="folk">Folk</option>
                      <option value="country">Country</option>
                      <option value="world">World</option>
                    </optgroup>

                    <optgroup label="Jazz, Blues & Soul">
                      <option value="jazz">Jazz</option>
                      <option value="blues">Blues</option>
                      <option value="soul">Soul</option>
                      <option value="gospel">Gospel</option>
                    </optgroup>

                    <optgroup label="Retro & Others">
                      <option value="disco">Disco</option>
                      <option value="ska">Ska</option>
                      <option value="lofi">Lo-fi</option>
                      <option value="chillout">Chillout</option>
                      <option value="ambient">Ambient</option>
                    </optgroup>
								</select>
								<label for="genreSelect">Genre</label>
						</div>
						<div class="form-floating">
							 	 <select name="sort" class="form-select" id="sortSelect" aria-label="Floating label select example">
									<option value="new">Newest</option>
									<option value="old">Oldest</option>
									<option value="ascending">A to Z</option>
									<option value="descending">Z to A</option>

								</select>
								<label for="sortSelect">Filter</label>
						</div>
						<button type="submit" class="btn btn-secondary">Search</button>

						</div>
						<div class="form-check form-switch mb-3 <%= user ? '' : 'd-none' %>">
  							<input class="form-check-input" name="showFav" type="checkbox" id="favoritesToggle">
  							<label class="form-check-label" for="favoritesToggle">Show only favorited tracks</label>
						</div>
					</form>
					<!-- <a class="song_a" href="#"><div class="row">
						<div class="col-md-4">
							<img alt="Bootstrap Image Preview" src="./img/Control-V.png" class="img-thumbnail">
						</div>
						<div class="col-md-8">
							<h3>
								&lt;SONG_NAME&gt;
							</h3>
							<p class="text-left">
								by &lt;ARTIST_NAME&gt;
							</p>
						</div>
					</div>
					</a>
					<br> -->
					<% if (error) {%>

                            <div class="toast errorToast rounded-0 w-100 align-items-center text-bg-danger bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body fs-6">
                                      <i class="bi bi-exclamation-triangle me-3"></i> <b>ERROR</b>: <%= error %>
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>

                            </div>
                            
                          <% } if (message){ %> 
							<div class="toast messageToast rounded-0 w-100 align-items-center text-bg-success bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
							<div class="d-flex">
								<div class="toast-body fs-6">
									  <i class="bi bi-check-circle me-3"></i> <b>SUCCESS</b>: <%= message %>
								</div>
								<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
							</div>
							</div>
						  <% } %>
					<% if (songs && songs.length > 0) { %>
						<% songs.forEach(song => { %>
							<a class="song_a" href="/song/<%= song._id %>">
								<div class="row mx-auto d-flex align-items-center py-3">
									<div class="col-md-4">
										<img alt="<%= song.title %>" src="<%= song.coverImage %>" class="img-thumbnail mx-auto d-block" style="width: 200px; height: 200px;" />
									</div>
									<div class="col-md-8">
										<h3><%= song.title %></h3>
										<p class="text-left">by @<%= song.artistName %></p>
										<p class="text-muted"> <%= toTitleCase(song.genre) %><br><i class="bi bi-star-fill"></i> <%= song.favoritesCount %></p>
										<% if (song.artistName === user?.username){ %>
											<i class = "fs-6 text-muted">
												This song was uploaded by you.
											</i>
										<% } %>
									</div>
								</div>
							</a>
								<% if ((song.artistName === user?.username )|| user?.isAdmin) { %>
									<div class="d-flex flex-row align-items-center">
										<a href="/edit-song/<%= song._id %>" class="btn btn-outline-light border-0 rounded-0 fs-4 flex-fill">
											<i class="bi bi-pencil-fill"></i>
										</a>								
										<button class="btn btn-outline-danger border-0 fs-4 rounded-0 flex-shrink-1" onclick="deleteSong(event, '<%= song._id %>')">
											<i class="bi bi-trash"></i> 
										</button>
									</div>

								<% } %>
						<% }) %>
					<% } else { %>
                            <div class="text-bg-danger bg-transparent border-0 h-100 text-center d-flex flex-column justify-content-center align-items-center">
								<i class="bi bi-exclamation-triangle me-3 text-white-50" style="font-size: 80px;"></i>
                                 <p class="fs-6 px-5 text-white-50">No results found for the tracks you're looking for. You either might have made a typo, chosen the wrong search options or we just don't have that track yet!</p> 

                            </div>
					<% } %>
                          
			<div class="d-flex justify-content-center h-100 align-items-end">
				<% 
				function buildQueryString(page, pre = true) {
					const params = new URLSearchParams();
					params.set('page', page);
					if (search) params.set('search', search);
					if (genre && genre !== 'any') params.set('genre', genre);
					if (sort && sort !== 'new') params.set('sort', sort);
					if ((previewNormal && previewNormal !== null) && pre) params.set('previewNormal', previewNormal);
					return '?' + params.toString();
				}
				%>

				<nav aria-label="navigation">
					<ul class="pagination justify-content-center mt-3">
						<% if (currentPage > 1) { %>
						<li class="page-item">
							<a class="page-link text-light" href="<%- buildQueryString(currentPage - 1) %>">«</a>
						</li>
						<% } else { %>
						<li class="page-item disabled">
							<span class="page-link text-light">«</span>
						</li>
						<% } %>

						<% for (let p = 1; p <= totalPages; p++) { %>
						<li class="page-item <%= p === currentPage ? 'active' : '' %>">
							<a class="page-link text-light" href="<% if (p !== currentPage){ %> <%- buildQueryString(p) %> <% }%>"><%= p %></a>
						</li>
						<% } %>

						<% if (currentPage < totalPages) { %>
						<li class="page-item">
							<a class="page-link text-light" href="<%- buildQueryString(currentPage + 1) %>">»</a>
						</li>
						<% } else { %>
						<li class="page-item disabled">
							<span class="page-link text-light">»</span>
						</li>
						<% } %>
					</ul>
				</nav>

			</div>
			</div>					
				</div>
				<div class="col-md-4">
					<div class="bg-black bg-opacity-25 h-100 p-3 rounded-3">

	
								
					<!-- <div class="accordion accordion-flush" id="accordionPanelsStayOpenExample">
						<div class="accordion-item">
							<h2 class="accordion-header">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
								<p><i class="me-3 bi bi-bar-chart-line-fill"></i> Top 5 Tracks</p>
							</button>
							</h2>
							<div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
							<div class="accordion-body">
								<p>Check out our all-time most popular tracks on DaBeat!</p>

							<table class="table table-striped-columns">

								<thead class="table-group-divider">
									<tr>
									<th scope="col">#</th>
									<th scope="col">Name</th>
									<th scope="col">Favorites</th>
									<th scope="col">Artist</th>
									</tr>
								</thead>
								<tbody>
									<tr>
									<th scope="row">1</th>
									<td>SONG 1</td>
									<td>1.2m</td>
									<td>@guy</td>
									</tr>
									<tr>
									<th scope="row">2</th>
									<td>SONG 2</td>
									<td>885k</td>
									<td>@man</td>
									</tr>
									<tr>
									<th scope="row">3</th>
									<td>SONG 3</td>
									<td>880k</td>
									<td>@woman</td>
									</tr>
								</tbody>
								</table>



							</div>
							</div>
						</div>
						<div class="accordion-item">
							<h2 class="accordion-header">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
								<p><i class="me-3 bi bi-clipboard-data"></i> Top 5 Artists</p>
							</button>
							</h2>
							<div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
							<div class="accordion-body">
								<p>Check out our all-time most popular artists on DaBeat!</p>
							<table class="table table-striped-columns">
			
								<thead class="table-group-divider">
									<tr>
									<th scope="col">#</th>
									<th scope="col">Name</th>
									<th scope="col">All songs' favorites</th>
									</tr>
								</thead>
								<tbody>
									<tr>
									<th scope="row">1</th>
									<td>@guy</td>
									<td>1.2m</td>
									</tr>
									<tr>
									<th scope="row">2</th>
									<td>@woman</td>
									<td>880k</td>
									</tr>
									<tr>
									<th scope="row">3</th>
									<td>@man</td>
									<td>885k</td>
									</tr>
								</tbody>
								</table>

							</div>
							</div>
						</div>
					


					
				</div> -->
					<% if (error2) {%>

                            <div class="toast errorToast rounded-0 w-100 align-items-center text-bg-danger bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body fs-6">
                                      <i class="bi bi-exclamation-triangle me-3"></i> <b>ERROR</b>: <%= error2 %>
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>

                            </div>
                            
                          <% } if (message2){ %> 
							<div class="toast messageToast rounded-0 w-100 align-items-center text-bg-success bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
							<div class="d-flex">
								<div class="toast-body fs-6">
									  <i class="bi bi-check-circle me-3"></i> <b>SUCCESS</b>: <%= message2 %>
								</div>
								<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
							</div>
							</div>
						  <% } %>
<div class="accordion accordion-flush" id="blockAccordion">

	<% renderedBlocks.slice().reverse().forEach((block, index) => { %>
	  <% if ( (block.type === "admin" && user?.isAdmin) || ( block.type === "new" && (Math.floor((Date.now() - user?.createdAt) / (1000 * 60 * 60 * 24)) < 7 || user?.isAdmin)  ) || ( block.type === "login" && user) || ( block.type === "everyone" ) ){ %>
      <div class="accordion-item">

        <h2 class="accordion-header">

          <button
            class="accordion-button collapsed <%= block.type === "login" ? "bg-primary-subtle" : "" %> <%= block.type === "new" ? "bg-warning-subtle" : "" %> <%= block.type === "admin" ? "bg-success-subtle" : "" %>"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse-<%= block._id %>"
            aria-expanded="false"
            aria-controls="collapse-<%= block._id %>"
          >
            <p class="m-0">
              <i class="me-3 bi bi-<%= block.bs_icon %> "></i>
              <%= block.title %>
            </p>
          </button>

        </h2>

        <div
          id="collapse-<%= block._id %>"
          class="accordion-collapse collapse"
        >
          <div class="accordion-body">
		<% if (user?.isAdmin){ %>
            <!-- EDIT AND DELETE BUTTON -->
            <button
              class="btn btn-outline-warning me-3 mb-3"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#edit-<%= block._id %>"
            >
              Edit
            </button>
            <button
              class="btn btn-outline-danger mb-3"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#delete-<%= block._id %>"
            >
              Delete
            </button>
   		<% } %>
            <!-- DELETE AND EDIT FORM SECTION -->
            <div class="collapse mb-3" id="delete-<%= block._id %>">
              <div class="card card-body bg-danger bg-opacity-25">

                <form
                  action="/admin/blocks/delete/<%= block._id %>"
                  method="POST"
                >
					<p>Are you sure you want to delete this? This action cannot be undone.</p>
                  <button type="submit" class="btn btn-danger">Yes, delete</button>
                </form>

              </div>
            </div>
			
            <div class="collapse mb-3" id="edit-<%= block._id %>">
              <div class="card card-body bg-warning bg-opacity-25">

                <form
                  action="/admin/blocks/edit/<%= block._id %>"
                  method="POST"
                >

				  <div class="mb-3">
                    <label class="form-label">Title <sup class="text-danger">*</sup></label>
                    <input
                      type="text"
                      class="form-control"
                      name="title"
                      value="<%= block.title %>"
                      required
                    >
                  </div>		  

                  <div class="mb-3">
                    <label class="form-label">Boostrap Icon (look up <a href="https://icons.getbootstrap.com/">here</a>)</label>
                    <input
                      type="text"
                      class="form-control mb-2"
                      name="bs_icon"
                      value="<%= block.bs_icon %>"                     
                    >
						<i class="text-muted">Remember to type only the icon's content after "bi-"</i>

                  </div>

				<div class="form-floating mb-3">
				<select
					class="form-select bor-bot focus-ring bg-transparent genre-select"
					id="floatingSelect"
					aria-label="Floating label select example"
					name="type"
				>
				<option value="new" <%= block.type === "new" ? "selected" : "" %> >For new users only (&lt; 7 days old), still visible to admins</option>
				<option value="login" <%= block.type === "login" ? "selected" : "" %> >For logged in users only</option>
				<option value="admin" <%= block.type === "admin" ? "selected" : "" %> >For admins only</option>
				<option value="everyone" <%= block.type === "everyone" ? "selected" : "" %> >For everyone</option>
				</select>


				<label for="floatingSelect">Set visibility <sup class="text-danger">*</sup></label>

				</div>
				  

                  <div class="mb-3">
                    <label class="form-label">Content (HTML/EJS supported) <sup class="text-danger">*</sup></label>
                    <textarea
                      class="form-control"
                      name="content"
                      rows="6"
                      required
					  placeholder="Only plain text editing is available in post editing."
                    ><%= block.raw %></textarea>
                  </div>

                  <button type="submit" class="btn btn-success">Save Changes</button>
                </form>

              </div>
            </div>

            <!-- RENDERED CONTENT PREVIEW -->
            <div class="mb-0">
              <%- block.html %>
			  <br><hr class="text-white-50 mb-1">
			  
			  <i class="fs-6 text-muted">This post was made on <%= block.createdAt.toLocaleDateString('en-GB') %>.<br>
				<% switch (block.type) { 
					case "new": %>
					Only users under 7 days old can see this.
				<% break; 
				case 'login': %>		
					Only logged in users can see this.
				<% break; 
				case 'admin': %>	
					Only admins can see this.
				<% break; 
 				default: %>
					
				<% } %>
			  </i>
			  
            </div>			
          </div>
        </div>

      </div>
	  <% } %>
    <% }); %>

  </div>

  <!-- CREATE NEW -->
<% if (user?.isAdmin){ %>
<hr class="my-5 text-white-50">

<h2 class="mb-3">Create Post</h2>

<form action="/admin/blocks/create" method="POST" onsubmit="syncEditorContent()">

    <div class="mb-3">
        <label class="form-label">Title <sup class="text-danger">*</sup></label>
        <input type="text" class="form-control" name="title" required>
    </div> 

	<div class="mb-3">
	<label class="form-label">Boostrap Icon (look up <a href="https://icons.getbootstrap.com/">here</a>)<br></label>
	<input
		type="text"
		class="form-control mb-2"
		name="bs_icon"
		value="<%=  %>"
		
	>
	<i class="text-muted">Remember to type only the icon's content after "bi-"</i>
	</div>

	<div class="form-floating mb-3">
	<select
		class="form-select bor-bot focus-ring bg-transparent genre-select"
		id="floatingSelect"
		aria-label="Floating label select example"
		name="type"
	>
	<option value="new">For new users only (&lt; 7 days old), still visible to admins</option>
	<option value="admin">For admins only</option>
	<option value="login">For logged in users only</option>
	<option value="everyone" selected>For everyone</option>
	</select>


	<label for="floatingSelect">Set visibility <sup class="text-danger">*</sup></label>

	</div>



    <div class="mb-3">
        <label class="form-label">Content (HTML/EJS supported) <sup class="text-danger">*</sup></label>

        <button type="button" id="toggle-editor" class="btn btn-secondary btn-sm ms-3 mb-2">
            Use Rich Editor
        </button>

		<div id="quill-wrapper" style="display: none;">
        	<div id="quill-editor" style="height: 250px; background: #212529;"></div>
		</div>

        <textarea id="plain-text-editor" class="form-control" placeholder="Using this plain text editor gives you freedom in customization, only if you know what you're doing. &#10 &#10Otherwise, consider switching to using rich text editor." rows="6"></textarea>

        <input type="hidden" name="content" id="final-content">
    </div>

    <button class="btn btn-primary"><i class="bi bi-plus-square-dotted me-3"></i>Create Block</button>

</form>
<br>
<i class="text-muted"><sup class="text-danger">*</sup> means the information is required.</i>


<!-- Quill CSS & JS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
    // Initialize Quill
    const quill = new Quill('#quill-editor', {
		placeholder: 'Using this rich text editor help design your post easier, at the cost of customization.\n\nSwitch to plain text editing if you prefer to design the post yourself.\n\n\nNOTE: This is a choice only when creating posts, editing will use plain text editing instead.\n\nEnsure the content is written carefully to avoid editing as much as possible if you aren\'t comfortable with raw HTML/EJS.',

        theme: 'snow',
        modules: {
            toolbar: [
				[{ 'header': [1, 2, 3, 4, 5, 6, false] }],
				['bold', 'italic', 'underline', 'strike'],        // toggled buttons
				['blockquote', 'code-block'],
				['link', 'image', 'video', 'formula'],

				[{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }],
				[{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
				[{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
				[{ 'direction': 'rtl' }],                         // text direction


				[{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
				[{ 'align': [] }],

				['clean']      
            ]
        }
    });

    let usingQuill = false;

    // Toggle Logic
    const toggleBtn = document.getElementById('toggle-editor');
	const quillWrapper = document.getElementById('quill-wrapper');
	const quillDiv = document.getElementById('quill-editor'); // still needed
	const plainText = document.getElementById('plain-text-editor');

	toggleBtn.addEventListener('click', () => {
		usingQuill = !usingQuill;

		if (usingQuill) {
			// Move textarea content -> Quill
			quill.root.innerHTML = plainText.value || "";
			quillWrapper.style.display = 'block';
			plainText.style.display = 'none';

			toggleBtn.textContent = "Use Plain Text";

		} else {
			// Get Quill HTML
			let html = quill.root.innerHTML.trim();

			// Normalize EMPTY Quill → EMPTY textarea
			if (html === "<p><br></p>" || html === "<p></p>" || html === "") {
				html = "";
			}

			plainText.value = html;

			quillWrapper.style.display = 'none';
			plainText.style.display = 'block';

			toggleBtn.textContent = "Use Rich Editor";
		}
	});




    // On submit, choose correct editor content
    function syncEditorContent() {
        const finalField = document.getElementById('final-content');

        if (usingQuill) {
            finalField.value = quill.root.innerHTML;
        } else {
            finalField.value = plainText.value;
        }
    }
</script>

<% } %>



				
			</div>

		</div>
		</div>
</div>
<footer class="footer bg-dark text-white mt-auto">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav>
                    <ul class="nav justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#">About us</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#">Credits</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
		<hr class="text-white-50 mt-1 mb-2">
        <div class="row">
            <div class="col-md-12 text-center pb-3">
                <p class="mb-0">© 2025 DaBeat. All rights reserved.</p>
            </div>
        </div>
    </div>

</footer>
<div class="modal fade" id="alertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-black bg-opacity-50 border border-danger">
          <div class="modal-header border border-danger">
            <h1 class="modal-title fs-5 text-danger" id="exampleModalLabel">Error</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ...
          </div>

        </div>
      </div>
  </div>
<script src ="/js/scripts.js"></script>
<script src="/js/delete_scripts.js"></script>

<script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const genre = urlParams.get('genre') || 'any';
    const sort = urlParams.get('sort') || 'new';
	const showFav = urlParams.get('showFav') || 'off';
    
    // Set form values based on URL parameters
    document.getElementById('searchInput').value = search;
    document.getElementById('genreSelect').value = genre;
    document.getElementById('sortSelect').value = sort;
	document.getElementById('favoritesToggle').checked = showFav === 'on';
</script>
</body></html>