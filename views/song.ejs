<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DaBeat - <%= song.title %></title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <link href="/css/style.css" rel="stylesheet" />
    	<style>
        body {
          background: url("/img/party_audience_on_spotlight_background_2107.jpg") center/cover no-repeat;
        }
        body::before {
          content: "";
          position: fixed;
          inset: 0;
          background: inherit;
          filter: blur(20px);
          z-index: -1;
        }
  </style>
</head>
<body style="background-color: black;" class="text-white d-flex flex-column min-vh-100">
  <% function toTitleCase(str) {
  return str
    .toLowerCase()
    .split(' ') 
    .map(word => word.charAt(0).toUpperCase() + word.slice(1)) 
    .join(' ');
} %>    




<nav class="navbar navbar-expand-lg navbar-dark bg-black bg-opacity-50">
    <div class="container-fluid">
        <a class="navbar-brand" href="/home"><h1><i class="bi bi-vinyl-fill"></i> DaBeat</h1></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNavDarkDropdown">
            <ul class="navbar-nav nav nav-underline me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/home"><i class="bi bi-houses-fill"></i> Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard"><i class="bi bi-music-player-fill"></i> Explore</a>
                </li>
            </ul>

            <hr class="d-lg-none text-white-50">
            
            <!-- Conditional rendering based on login status -->
            <% if (user) { %>
                <!-- Logged in user - show profile dropdown -->
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fs-5" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <%= user.username %>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                            <li><a class="dropdown-item" href="/upload"><i class="bi bi-upload"></i> Upload</a></li>
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-bounding-box"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear-fill"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Account actions</h6></li>
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-door-closed"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            <% } else { %>
                <!-- Not logged in - show login/signup buttons -->
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-box-arrow-in-right"></i> Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-primary text-white ms-2" href="/"><i class="bi bi-person-plus"></i> Sign Up</a>
                    </li>
                </ul>
            <% } %>
        </div>
    </div>
</nav>	
    <% if (song) { %>
    <div class="container-fluid bg-black bg-opacity-50 flex-fill pt-4">
            <% if (error) {%>

            <div class="toast errorToast rounded-0 w-100 align-items-center text-bg-danger bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6">
                        <i class="bi bi-exclamation-triangle me-3"></i> <b>ERROR</b>: <%= error %>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>

            </div>
            
            <% } if (success){ %> 
            <div class="toast messageToast rounded-0 w-100 align-items-center text-bg-success bg-opacity-10 border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6">
                        <i class="bi bi-check-circle me-3"></i> <b>SUCCESS</b>: <%= success %>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            </div>
            <% } %>	
        <div class="card mb-3">
            <div class="row d-flex align-items-start">
                <div class="col-md-3 align-self-center">
                    <div class="card-body">
                    <img alt="<%= song.title %>" src="<%= song.coverImage %>" class="song-img-song img-thumbnail">

                    </div>
                </div>
                <div class="col-md-9 ">
                    <div class="card-body">

                        <h5 class="card-title mt-2"><%= song.title %></h5>
                        <h6 class="card-subtitle mb-4 text-body-secondary">by <a href="<%= authorExists ? `/profile/${song.artistName}` : "" %>" class="<%= authorExists ? "" : "text-decoration-line-through text-muted" %>"> @<%= song.artistName %> </a>                         <% if (!authorExists) {%>
                        <i class="card-subtitle ms-3 mb-4 text-body-secondary text-muted">(This user's account has been deleted)</i><br>
                        <% } %></h6>

                        <span class="flex-shrink-1 card-text">Genre: <a href="/dashboard?search=&genre=<%= song.genre %>" class="card-link"><%= toTitleCase(song.genre) %></a></span>

                        <p class="card-text flex-grow-1" style="max-height: 200px; overflow: auto">
                            <i class="text-muted"><%= song.description || "There's no description for this track." %>
                            </i>
                        </p>
                            <a href="<%= user ? `/song/${song._id}/favorite` : '' %>" data-bs-toggle="tooltip" data-bs-title="<%= isFavorited ? 'Remove from' : 'Add to'%> Favorites" data-bs-placement="right" class="border-0 mb-2 bg-gradient btn <%= isFavorited ? 'btn-primary' : 'btn-secondary' %> text-start fav-count text-decoration-none <%= user ? ' ': 'disabled' %>">
                                <p class="my-auto">
                                    <i class="bi bi-star-fill fav-star <%= isFavorited ? 'text-warning' : 'text-white' %>"></i> <%= song.favoritesCount %>
                                </p>
                            </a>                           
                    </div>

                </div>     
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <div>
                        <p class="fs-6 mb-0">Uploaded on: <b><%= song.uploadedAt.toLocaleDateString('en-GB'); %></b></p>
                        <% if (song.tags && song.tags.length > 0) { %>
                            
                        <% song.tags.forEach(function(tag) { %>
                            <a href="/dashboard?search=<%= tag %>" class="badge bg-primary text-decoration-none me-1"><%= tag %></a>
                        <% })}; %>
                    </div>
                    <% if (user && (song.artistName === user.username || user.isAdmin)) { %>
                        <div class="align-self-center ms-auto">
                        <a href="/edit-song/<%= song._id %>" class="btn fs-5 me-3" data-bs-toggle="tooltip" data-bs-title="Modify the song's details, like titles, description, etc..." data-bs-placement="left">
                            <i class="bi bi-pencil-fill me-3"></i> Edit
                        </a>
                        <button class="btn btn-outline-danger fs-5" onclick="deleteSong(event, '<%= song._id %>')">
                            <i class="bi bi-trash me-3"></i> Delete
                        </button>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

                        <ul class="list-group">
                            <li class="list-group-item" id="waveform"></li>
                            <li class="list-group-item">
                            <div class="btn-group w-100">
                                <div class="border-0 bg-gradient btn btn-primary togglePause" onclick="togglePause()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Play/Pause"><i class="bi bi-play-fill"></i></div>
                                <div class="border-0 bg-gradient btn btn-primary stopMusic" onclick="stopMusic()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Jump to start"><i class="bi bi-stop-fill"></i></div>
                                <div class="border-0 bg-gradient btn btn-secondary toggleLoop" onclick="toggleLoop()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Toggle loop"><i class="bi bi-arrow-repeat"></i></div>
                                <div class="border-0 bg-gradient btn btn-secondary togglePrePit" onclick="togglePrePit()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Toggle preserve pitch"><i class="bi bi-speedometer"></i></div>                                
                                <div data-bs-toggle="tooltip" data-bs-title="Playback speed" class="border-0 bg-gradient bg-secondary speedLabel d-flex align-items-center justify-content-center px-3">
                                <label>
                                    <span id="rangeValue" aria-hidden="true">1.00</span>x
                                </label>
                                </div>
                                <div class="border-0 bg-gradient w-25 bg-secondary sliderContainer d-flex align-items-center justify-content-center px-3">
                                    <input
                                        type="range"
                                        class="slider forSpeed"
                                        min="0"
                                        max="7"
                                        value="3"
                                        step="1"
                                        id="rangeSp"
                                    />                                   
                                </div>
                                <div data-bs-toggle="tooltip" data-bs-title="Volume" class="btn border-0 bg-gradient volumeLabel btn-secondary">
                                    <i class="bi bi-volume-up-fill"></i>
                                </div>
                                <div class="border-0 bg-gradient w-25 bg-secondary volumeContainer d-flex align-items-center justify-content-center px-3">
                                    <input
                                        type="range"
                                        class="slider forVolume"
                                        min="0"
                                        max="100"
                                        value="100"
                                        step="1"
                                        id=""
                                    />                                   
                                </div>                                
                                <div class="border-0 bg-gradient btn btn-secondary w-100 disabled"><span id="time">0:00</span> / <span id="duration">0:00</span></div>



                            </div>                                
                            </li>
                        </ul>
    </div>
    <% } %>
    <script type="module">
        import WaveSurfer from 'https://cdn.jsdelivr.net/npm/wavesurfer.js/dist/wavesurfer.esm.js';
        import Hover from 'https://cdn.jsdelivr.net/npm/wavesurfer.js/dist/plugins/hover.esm.js'

        const wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: 'rgb(255, 255, 255)',
        progressColor: 'rgb(0, 125, 255)',
        url: '<%= (song? song.audioFile : null) %>',
        dragToSeek: true,
        plugins: [
            Hover.create({
            lineColor: '#ff0000',
            lineWidth: 0,
            labelBackground: '',
            labelColor: '#fff',
            labelSize: '15px',
            labelPreferLeft: false,
            }),
        ],        
        audioRate: 1, // set the initial playback rate
        renderFunction: (channels, ctx) => {
            const { width, height } = ctx.canvas
            const scale = channels[0].length / width
            const step = 10

            ctx.translate(0, height / 2)
            ctx.strokeStyle = ctx.fillStyle
            ctx.beginPath()

            for (let i = 0; i < width; i += step * 2) {
            const index = Math.floor(i * scale)
            const value = Math.abs(channels[0][index])
            let x = i
            let y = value * height

            ctx.moveTo(x, 0)
            ctx.lineTo(x, y)
            ctx.arc(x + step / 2, y, step / 2, Math.PI, 0, true)
            ctx.lineTo(x + step, 0)

            x = x + step
            y = -y
            ctx.moveTo(x, 0)
            ctx.lineTo(x, y)
            ctx.arc(x + step / 2, y, step / 2, Math.PI, 0, false)
            ctx.lineTo(x + step, 0)
            }

            ctx.stroke()
            ctx.closePath()
        },
        })


        const sC = document.querySelector(".sliderContainer");
        const sL = document.querySelector(".speedLabel");
        const vC = document.querySelector(".volumeContainer");
        const vL = document.querySelector(".volumeLabel");
        let preservePitch = false;
        let muted = false;
        const speeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];

        // Toggle pitch preservation
        document.querySelector('.togglePrePit').addEventListener('click', (e) => {
            preservePitch = !preservePitch;
            wavesurfer.setPlaybackRate(wavesurfer.getPlaybackRate(), preservePitch);
        })

        document.querySelector('.volumeLabel').addEventListener('click', (e) => {
            muted = !muted;
            wavesurfer.setMuted(muted);
            e.currentTarget.innerHTML = muted === true ? `<i class="bi bi-volume-mute-fill"></i>` : getIcontoVolume();
            if (wavesurfer.getVolume() < 1 || muted === true){
                vC.classList.remove("bg-secondary");
                vC.classList.add("bg-primary");   
                vL.classList.remove("bg-secondary");
                vL.classList.add("bg-primary");                                 
            }
            else{
                vC.classList.add("bg-secondary");
                vC.classList.remove("bg-primary");   
                vL.classList.add("bg-secondary");
                vL.classList.remove("bg-primary");                                       
            }            
        })
        function getIcontoVolume(){
            return wavesurfer.getVolume() > 0.5 ? `<i class="bi bi-volume-up-fill"></i>` :  wavesurfer.getVolume() > 0 ? `<i class="bi bi-volume-down-fill"></i>` : `<i class="bi bi-volume-off-fill"></i>`;
            
        }

        // Set the playback rate
        document.querySelector('.slider.forSpeed').addEventListener('input', (e) => {
            const speed = speeds[e.target.valueAsNumber];
            document.querySelector('#rangeValue').textContent = speed.toFixed(2);
            wavesurfer.setPlaybackRate(speed, preservePitch);


            if (speed != 1){
                sC.classList.remove("bg-secondary");
                sC.classList.add("bg-primary");   
                sL.classList.remove("bg-secondary");
                sL.classList.add("bg-primary");                                 
            }
            else{
                sC.classList.add("bg-secondary");
                sC.classList.remove("bg-primary");   
                sL.classList.add("bg-secondary");
                sL.classList.remove("bg-primary");                                       
            }
        })
        document.querySelector('.slider.forVolume').addEventListener('input', (e) => {
            const volume = e.target.valueAsNumber / 100;
            wavesurfer.setVolume(volume);

            vL.innerHTML = muted === true ? `<i class="bi bi-volume-mute-fill"></i>` : getIcontoVolume();

            if (volume < 1 || muted === true){
                vC.classList.remove("bg-secondary");
                vC.classList.add("bg-primary");   
                vL.classList.remove("bg-secondary");
                vL.classList.add("bg-primary");                                 
            }
            else{
                vC.classList.add("bg-secondary");
                vC.classList.remove("bg-primary");   
                vL.classList.add("bg-secondary");
                vL.classList.remove("bg-primary");                                       
            }
        })

        window.wavesurfer = wavesurfer;
        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const secondsRemainder = Math.round(seconds) % 60;
            const paddedSeconds = `0${secondsRemainder}`.slice(-2);
            return `${minutes}:${paddedSeconds}`;
        }

        const timeEl = document.querySelector('#time');
        const durationEl = document.querySelector('#duration');
        wavesurfer.on('decode', (duration) => (durationEl.textContent = formatTime(duration)));
        wavesurfer.on('timeupdate', (currentTime) => (timeEl.textContent = formatTime(currentTime)));
        wavesurfer.on('finish', () => {


            if (tL.classList.contains("btn-primary")){
                wavesurfer.setTime(0);
                wavesurfer.play();
                tP.innerHTML = `<i class="bi bi-pause-fill"></i>`;


            }
            else{
                tP.innerHTML = `<i class="bi bi-play-fill"></i>`;
            }
        })

    </script>   

    <script>
            const tP = document.querySelector(".togglePause")
            const tPP = document.querySelector(".togglePrePit")
            const tL = document.querySelector(".toggleLoop")
            const prePit = false;


        function togglePause() {

            if (!window.wavesurfer) return // safety check

            if (window.wavesurfer.isPlaying()) {
            window.wavesurfer.pause();
            tP.innerHTML = `<i class="bi bi-play-fill"></i>`;
            } else {
            window.wavesurfer.play();
            tP.innerHTML = `<i class="bi bi-pause-fill"></i>`;

            }
        }

        function stopMusic() {
            window.wavesurfer.setTime(0);
            window.wavesurfer.pause();
            tP.innerHTML = `<i class="bi bi-play-fill"></i>`;

        }

        function togglePrePit() {
            if (tPP.classList.contains("btn-primary")) {
                tPP.classList.remove("btn-primary");
                tPP.classList.add("btn-secondary");               
            }
            else{
                tPP.classList.add("btn-primary");
                tPP.classList.remove("btn-secondary");        
            }
        }

        function toggleLoop() {
            if (tL.classList.contains("btn-primary")) {
                tL.classList.remove("btn-primary");
                tL.classList.add("btn-secondary");
            }
            else{
                tL.classList.add("btn-primary");
                tL.classList.remove("btn-secondary");        
            }
        }

    </script>
<footer class="footer bg-dark text-white mt-auto">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav>
                    <ul class="nav justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#">About us</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#">Credits</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
		<hr class="text-white-50 mt-1 mb-2">
        <div class="row">
            <div class="col-md-12 text-center pb-3">
                <p class="mb-0">Â© 2025 DaBeat. All rights reserved.</p>
            </div>
        </div>
    </div>

</footer>
<div class="modal fade" id="alertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-black bg-opacity-50 border border-danger">
          <div class="modal-header border border-danger">
            <h1 class="modal-title fs-5 text-danger" id="exampleModalLabel">Error</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ...
          </div>

        </div>
      </div>
  </div>
    <script src="/js/scripts.js"></script>
    <script src="/js/delete_scripts.js"></script>
</body>
</html>